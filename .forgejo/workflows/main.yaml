---
on:
  push:
    branches:
      - 'main'
  workflow_dispatch:

jobs:
  all:
    runs-on: 'self-hosted'
    steps:
      - name: 'checkout'
        run: |
          set -eu
          git init --quiet --initial-branch main
          git remote add origin "https://git.adyxax.org/${GITHUB_REPOSITORY}.git"
          git fetch --quiet --no-tags --depth=1 origin "$GITHUB_SHA"
          git checkout --quiet "$GITHUB_SHA"
      - name: 'fmt'
        run: './make.sh tidy --fail-if-dirty=true'
      - name: 'build'
        run: './make.sh build'
      # we need the build step done before running check because the `search`
      # server embeds the `index.html` file, which gets generated by hugo during
      # the build step.
      - name: 'check'
        run: './make.sh check'
      - name: 'deploy'
        run: './make.sh deploy'
        env:
          SSH_PRIVATE_KEY: '${{ secrets.SSH_PRIVATE_KEY }}'
