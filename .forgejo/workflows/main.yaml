---
on:
  push:
    branches:
      - 'main'
  workflow_dispatch:

jobs:
  all:
    runs-on: 'self-hosted'
    steps:
      - name: 'checkout'
        run: |
          set -euCo pipefail
          mkdir -p "$GITHUB_WORKSPACE"
          cd "$GITHUB_WORKSPACE"
          git init --quiet --initial-branch main
          git remote add origin "https://git.adyxax.org/${GITHUB_REPOSITORY}.git"
          git fetch --quiet --no-tags --prune --depth=1 origin "$GITHUB_SHA"
          git checkout --quiet "$GITHUB_SHA"
      - name: 'fmt'
        run: './make.sh tidy --fail-if-dirty=true'
      - name: 'build'
        run: './make.sh build'
      # we need the build step done before the go checks can run because we need
      # the index.html file generated by the hugo build
      - name: 'check'
        run: './make.sh check'
      - name: 'deploy'
        run: './make.sh deploy'
        env:
          SSH_PRIVATE_KEY: '${{ secrets.SSH_PRIVATE_KEY }}'
